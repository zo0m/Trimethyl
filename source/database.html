<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Cache-Database'>/**
</span> * @class  	Cache.Database
 * @author  Flavio De Stefano &lt;flavio.destefano@caffeinalab.com&gt;
 */

var SQLite = require(&#39;T/sqlite&#39;);
var Util = require(&#39;T/util&#39;);

var DIR = Ti.Filesystem.applicationCacheDirectory + &#39;database&#39;;
Ti.Filesystem.getFile(Ti.Filesystem.applicationCacheDirectory).createDirectory();
Ti.Filesystem.getFile(DIR).createDirectory();

<span id='Cache-Database-method-get'>/**
</span> * @method get
 * Get an entry
 * @param  {String} hash
 * @param  {Boolean} bypassExpire
 * @return {Ti.Blob}
 */
exports.get = function(hash, bypassExpire) {
	var row = DB.row(&#39;SELECT expire, info FROM cache WHERE hash = ? LIMIT 1&#39;, hash);
	if (row == null) return null;

	if (bypassExpire === true) {
		Ti.API.debug(&#39;Cache: Get bypassed&#39;);
	}

	var expire = row.expire &lt;&lt; 0;
	if (bypassExpire !== true &amp;&amp; expire !== -1 &amp;&amp; Util.now() &gt; expire) return null;

	var file = Ti.Filesystem.getFile(DIR, hash);
	if (!file.exists()) return null;

	return {
		value: file.read(),
		expire: expire,
		info: Util.parseJSON(row.info)
	};
};

<span id='Cache-Database-method-set'>/**
</span> * @method set
 * Set a new entry
 * @param {String} 	hash
 * @param {Object} 	value
 * @param {Number} 	ttl
 * @param {Object} 	info
 */
exports.set = function(hash, value, ttl, info) {
	info = JSON.stringify(info || {});
	if (_.isObject(value) || _.isArray(value)) value = JSON.stringify(value);

	var expire = -1;
	if (ttl != null) {
		expire = Util.fromNow(ttl);
	}

	DB.execute(&#39;INSERT OR REPLACE INTO cache (hash, expire, info) VALUES (?, ?, ?)&#39;, hash, expire, info);
	Ti.Filesystem.getFile(DIR, hash).write(value);
};


<span id='Cache-Database-method-remove'>/**
</span> * @method remove
 * Remove an entry
 * @param  {String} 	hash
 */
exports.remove = function(hash) {
	DB.execute(&#39;DELETE FROM cache WHERE hash = ?&#39;, hash);
	Ti.Filesystem.getFile(DIR, hash).deleteFile();
};

<span id='Cache-Database-method-purge'>/**
</span> * @method purge
 * Prune all
 */
exports.purge = function() {
	DB.execute(&#39;DELETE FROM cache WHERE 1&#39;);
	Ti.Filesystem.getFile(DIR).deleteDirectory(true);
	Ti.Filesystem.getFile(DIR).createDirectory();
};

<span id='Cache-Database-method-getSize'>/**
</span> * @method getSize
 * @return {Number}
 */
exports.getSize = function() {
	return T(&#39;filesystem&#39;).getSize(DIR);
};


/*
Init
*/

var DB = new SQLite(&#39;app&#39;);
DB.execute(&#39;CREATE TABLE IF NOT EXISTS cache (hash TEXT PRIMARY KEY, expire INTEGER, info TEXT)&#39;);
</pre>
</body>
</html>
